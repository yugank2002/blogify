<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('./partials/head.ejs') %>
    <title>BlogiFY - <%= blog.title %></title>
    <style>
        /* Base styles for the entire page content area */
        .main-content-wrapper {
            flex-grow: 1;
            padding: 20px; /* Overall padding around the layout */
            box-sizing: border-box;
            background-color: var(--background-color); /* Use your general page background */
            display: flex; /* Make main-content-wrapper a flex container */
            justify-content: center; /* Center its content */
            align-items: flex-start; /* Align content to the top */
        }

        /* Flexbox layout for the blog post and comments */
        .blog-page-layout {
            display: flex;
            flex-wrap: nowrap; /* Prevent columns from wrapping by default for desktop */
            gap: 30px; /* Space between the main content and sidebar */
            max-width: 1400px; /* Max width for the entire layout */
            width: 100%; /* Ensure it takes available width within main-content-wrapper */
            align-items: flex-start; /* Align columns to the top */
        }

        /* Left column: Blog Main Content (75% width) */
        .blog-main-content {
            flex: 3; /* Takes 3 parts of available space, roughly 75% */
            min-width: 0; /* Allows content to shrink */
            padding: 40px;
            background-color: var(--card-background); /* White or off-white background */
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            animation: fadeIn 0.8s ease-out;
            overflow-y: auto; /* Make blog content scrollable if it exceeds viewport height */
            /* Adjust 80px for your nav height, and 40px for main-content-wrapper padding (20px top + 20px bottom) */
            max-height: calc(100vh - var(--nav-height) - 40px);
            -ms-overflow-style: none; /* For IE and Edge */
            scrollbar-width: none; /* For Firefox */
        }
        .blog-main-content::-webkit-scrollbar {
            display: none; /* For Chrome, Safari, and Opera */
        }

        /* Right column: Combined Comments & Add Comment (25% width, fixed) */
        .blog-sidebar-comments-combined {
            flex: 1; /* Takes 1 part of available space, roughly 25% */
            min-width: 300px; /* Minimum width for comments sidebar */
            background-color: var(--background-light); /* Lighter background for the entire comments card */
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            display: flex;
            flex-direction: column; /* Stack comments list and form vertically */
            position: sticky; /* Make it sticky */
            /* Adjust 20px based on desired top offset from main-content-wrapper's top padding */
            top: 20px;
            /* Ensure it doesn't overflow the viewport, accounting for nav and wrapper padding */
            max-height: calc(100vh - var(--nav-height) - 40px);
            box-sizing: border-box;
        }

        /* Comments header within the combined card */
        .comments-section-header {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-align: center;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        .no-comments-message {
            text-align: center;
            color: #777;
            padding: 20px 0; /* Add some padding for better visual spacing */
        }


        /* Comments List Container - This is the element that will scroll */
        .comments-list-container {
            flex-grow: 1; /* Allows comment list to take up remaining vertical space */
            overflow-y: auto; /* MAKE THIS SECTION SCROLLABLE */
            -ms-overflow-style: none; /* For IE and Edge */
            scrollbar-width: none; /* For Firefox */
            padding-right: 10px; /* Add some padding for the scrollbar if it appears */
            margin-bottom: 20px; /* Space between comments list and add comment form */
            display: flex; /* Use flex for comments list to manage individual items */
            flex-direction: column;
        }
        .comments-list-container::-webkit-scrollbar {
            display: none; /* For Chrome, Safari, and Opera */
        }

        /* Individual comment styling (minimized, chat-like) */
        .comment-item {
            background-color: var(--card-background); /* Slightly different background for individual comments */
            padding: 10px 15px; /* Minimized padding */
            border-radius: 10px; /* Slightly less rounded for compactness */
            margin-bottom: 10px; /* Minimized space between comments */
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.03); /* Lighter shadow */
            flex-shrink: 0; /* Prevent comments from shrinking when scrolling */
        }

        .comment-text {
            color: var(--text-dark);
            font-size: 0.95rem; /* Slightly smaller font size */
            line-height: 1.4; /* Minimized line height */
            margin-bottom: 5px; /* Minimized space */
        }

        .comment-meta {
            font-size: 0.75rem; /* Smaller meta font size */
            color: #888;
            text-align: right;
            white-space: nowrap; /* Keep on one line if possible */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .comment-meta strong {
            color: var(--primary-color);
        }

        /* Add Comment Form */
        .add-comment-form {
            flex-shrink: 0; /* Prevent form from shrinking */
            padding-top: 10px; /* Padding for the top of the form within the combined card */
        }
        .add-comment-form h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px; /* Minimized margin */
            font-size: 1.5em; /* Minimized heading size */
            text-align: center;
        }
        .comment-input {
            width: 100%;
            padding: 10px 12px; /* Minimized padding */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem; /* Minimized font size */
            color: var(--text-dark);
            background-color: var(--background-light);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
            resize: vertical;
            min-height: 50px; /* Minimized height */
            margin-bottom: 12px; /* Minimized margin */
        }
        .comment-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 188, 212, 0.25);
            outline: none;
        }
        .comment-submit-button {
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 10px 20px; /* Minimized padding */
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem; /* Minimized font size */
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
        }
        .comment-submit-button:hover {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* --- Existing Blog Post Styles (Main Content - unchanged) --- */
        .blog-post-title { color: var(--primary-color); font-size: 2.8em; font-weight: 700; margin-bottom: 20px; line-height: 1.2; text-align: center; }
        .blog-post-meta { text-align: center; color: #777; font-size: 0.95rem; margin-bottom: 30px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .blog-post-meta span { display: inline-block; }
        .blog-post-cover { width: 100%; max-height: 400px; object-fit: cover; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .blog-post-description { font-size: 1.15rem; line-height: 1.8; color: var(--text-dark); margin-bottom: 40px; text-align: justify; }
        .separator { border: none; border-top: 1px solid var(--border-color); margin: 40px 0; }
        .author-section { display: flex; align-items: center; gap: 20px; padding: 20px; background-color: var(--background-light); border-radius: 10px; margin-bottom: 40px; flex-wrap: wrap; }
        .author-profile-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); flex-shrink: 0; }
        .author-details h3 { color: var(--primary-color); font-size: 1.5em; margin-top: 0; margin-bottom: 5px; }
        .author-details p { margin: 0; color: #555; font-size: 0.95rem; }
        .author-details p strong { color: var(--text-dark); }
        .action-buttons { text-align: center; margin-top: 30px; margin-bottom: 20px; }
        .action-button, .delete-button { display: inline-block; padding: 12px 25px; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; text-decoration: none; margin: 0 10px; }
        .action-button { background-color: var(--accent-color); color: var(--text-light); border: none; }
        .action-button:hover { background-color: #0097a7; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .delete-button { background-color: #dc3545; color: var(--text-light); border: none; }
        .delete-button:hover { background-color: #c82333; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) { /* Adjust breakpoint for two columns to stack */
            .blog-page-layout {
                flex-direction: column; /* Stack columns on smaller screens */
                gap: 20px;
                flex-wrap: wrap; /* Allow wrapping when stacked */
            }
            .blog-main-content,
            .blog-sidebar-comments-combined {
                flex: none; /* Remove flex sizing */
                width: 100%; /* Take full width */
                min-width: unset; /* Reset min-width */
                position: static; /* Remove sticky positioning when stacked */
                max-height: unset; /* Remove max height when stacked */
                overflow-y: visible; /* Allow normal scrolling for main content when stacked */
            }
            .blog-main-content {
                padding: 30px;
            }
            .blog-post-title {
                font-size: 2.2em;
            }
            .comments-list-container {
                max-height: 300px; /* Give comments a fixed max height with scroll when stacked */
                overflow-y: auto; /* Enable scrolling for comments list when stacked */
            }
        }

        @media (max-width: 768px) {
            .main-content-wrapper {
                padding: 15px;
            }
            .blog-main-content {
                padding: 20px;
                border-radius: 10px;
            }
            .blog-post-title {
                font-size: 1.8em;
                margin-bottom: 15px;
            }
            .blog-post-meta {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 20px;
            }
            .blog-post-description {
                font-size: 1rem;
                line-height: 1.6;
                margin-bottom: 30px;
            }
            .author-section {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            .author-profile-photo {
                margin-bottom: 10px;
            }
            .action-button,
            .delete-button {
                display: block;
                width: calc(100% - 20px);
                margin: 10px auto;
            }
            .blog-sidebar-comments-combined {
                padding: 15px;
                border-radius: 10px;
            }
            .comments-section-header {
                font-size: 1.5em;
            }
            .comment-item {
                padding: 8px 12px;
                margin-bottom: 8px;
            }
            .comment-text {
                font-size: 0.9rem;
            }
            .comment-meta {
                font-size: 0.7rem;
            }
            .comment-input {
                padding: 8px 10px;
                min-height: 40px;
            }
            .comment-submit-button {
                padding: 8px 15px;
            }
        }
        /* Define --nav-height if not already in head.ejs */
        :root {
            --nav-height: 60px; /* Example value, adjust to your actual nav height */
        }
    </style>
</head>
<body>
    <%- include('./partials/nav.ejs') %>

    <div class="main-content-wrapper">
        <div class="blog-page-layout">
            <div class="blog-main-content">
                <h1 class="blog-post-title"><%= blog.title %></h1>

                <div class="blog-post-meta">
                    <span>**Created:** <%= blog.createdAt.toLocaleString() %></span>
                    <% if (blog.updatedAt && blog.createdAt.getTime() !== blog.updatedAt.getTime()) { %>
                        <span>**Last Updated:** <%= blog.updatedAt.toLocaleString() %></span>
                    <% } %>
                </div>

                <img src="<%= blog.coverPhoto %>" alt="<%= blog.title %> Cover Photo" class="blog-post-cover">

                <% if (blog.video) { %>
                    <video controls src="<%= blog.video %>" class="blog-post-cover" style="max-height:480px; margin-top:20px; margin-bottom:30px; width:100%;"></video>
                <% } %>

                <p class="blog-post-description"><%= blog.description %></p>

                <hr class="separator">

                <div class="author-section">
                    <img src="<%= blog.createdBy.profilePhoto %>" alt="<%= blog.createdBy.fullName %>'s Profile Photo" class="author-profile-photo">
                    <div class="author-details">
                        <h3>Posted By: <%= blog.createdBy.fullName %></h3>
                        <p><strong>Email:</strong> <%= blog.createdBy.email %></p>
                    </div>
                </div>

                <% if (user && blog.createdBy._id.toString() === user.userid.toString()) { %>
                    <div class="action-buttons">
                        <a href="/edit/<%= blog._id %>" class="action-button">Edit Blog</a>
                        <form action="/edit/delete/<%= blog._id %>" method="POST" style="display:inline;">
                            <button type="submit" class="delete-button">Delete Blog</button>
                        </form>
                    </div>
                <% } %>
            </div>

            <div class="blog-sidebar-comments-combined">
                <% if (comments && comments.length > 0) { %>
                    <h3 class="comments-section-header">Comments(<%= comments.length %>)</h3>
                    <div class="comments-list-container">
                        <div class="comments-list">
                            <% comments.forEach(comment => { %>
                                <div class="comment-item">
                                    <p class="comment-text"><%= comment.comment %></p>
                                    <p class="comment-meta">
                                        by <strong><%= comment.createdBy.fullName %></strong> on <%= new Date(comment.createdAt).toLocaleString() %>
                                    </p>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                <% } else { %>
                    <p class="no-comments-message">No comments yet. Be the first to comment!</p>
                    <div class="comments-list-container" style="flex-grow: 1; min-height: 50px;"></div> 
                <% } %>

                <div class="add-comment-form">
                    <h3>Add a Comment</h3>
                    <form action="/blog/<%= blog._id %>" method="post">
                        <textarea name="comment" id="comment" class="comment-input" placeholder="Write your comment here..." required></textarea>
                        <button type="submit" class="comment-submit-button">Post Comment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
   
</body>
</html>